<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistema de Chamados</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  @keyframes blink {
    0%, 50%, 100% { background-color: #f87171; }
    25%, 75% { background-color: #fca5a5; }
  }
  .blink td { animation: blink 1s infinite; }
  .btn-edit { background-color: #facc15; color: #000; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
  .btn-edit:hover { background-color: #eab308; }
  .btn-close { background-color: #ef4444; color: #fff; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
  .btn-close:hover { background-color: #b91c1c; }
  .btn-details { background-color: #3b82f6; color: #fff; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
  .btn-details:hover { background-color: #1d4ed8; }
</style>
</head>
<body class="bg-gray-100 text-gray-900">

<!-- Tela de Login -->
<div id="loginScreen" class="flex justify-center items-center min-h-screen">
  <div class="bg-white shadow-lg rounded-lg p-8 w-96">
    <h1 class="text-2xl font-bold mb-4">Login</h1>
    <form id="loginForm" class="space-y-2">
      <input id="loginUser" placeholder="Usu√°rio" class="border p-2 w-full" required />
      <input id="loginPass" type="password" placeholder="Senha" class="border p-2 w-full" required />
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded w-full">Entrar</button>
    </form>
  </div>
</div>

<!-- Tela do Sistema -->
<div id="systemScreen" class="p-6 hidden">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Sistema de Chamados</h1>
    <div>
      <button id="btnUserRegister" class="px-4 py-2 bg-green-600 text-white rounded hidden">Cadastrar Usu√°rio</button>
      <button id="btnLogout" class="px-4 py-2 bg-red-600 text-white rounded ml-2">Logout</button>
    </div>
  </div>

  <!-- Aviso de expira√ß√£o -->
  <div id="expirationNotice" class="mb-4 p-3 bg-yellow-100 text-yellow-800 rounded shadow hidden"></div>

  <div class="flex gap-2 mb-4">
    <button id="btnSettings" class="px-4 py-2 bg-blue-600 text-white rounded">‚öôÔ∏è Configura√ß√µes</button>
    <button id="btnReport" class="px-4 py-2 bg-purple-600 text-white rounded">üìÑ Relat√≥rio</button>
  </div>

  <form id="ticketForm" class="mt-4 space-y-2">
    <input id="subject" placeholder="Assunto" class="border p-2 w-full" required />
    <input id="client" placeholder="Cliente" class="border p-2 w-full" required />
    <select id="tech" class="border p-2 w-full" required></select>
    <select id="priority" class="border p-2 w-full">
      <option value="low">Baixa</option>
      <option value="medium">M√©dia</option>
      <option value="high">Alta</option>
      <option value="critical">Cr√≠tica</option>
    </select>
    <textarea id="description" placeholder="Descri√ß√£o" class="border p-2 w-full"></textarea>
    <div class="flex gap-2">
      <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Abrir Chamado</button>
      <button type="button" id="cancelEditBtn" class="px-4 py-2 bg-red-500 text-white rounded hidden" onclick="cancelEdit()">Cancelar</button>
    </div>
  </form>

  <table class="mt-6 w-full border">
    <thead>
      <tr class="bg-gray-200">
        <th class="border px-4 py-2">Assunto</th>
        <th class="border px-4 py-2">Cliente</th>
        <th class="border px-4 py-2">T√©cnico</th>
        <th class="border px-4 py-2">Prioridade</th>
        <th class="border px-4 py-2">Status</th>
        <th class="border px-4 py-2">A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="ticketsList"></tbody>
  </table>
</div>

<!-- Modal: Cadastro Usu√°rio -->
<div id="userModal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h2 class="text-xl font-bold mb-4">Cadastrar Usu√°rio</h2>
    <form id="userForm" class="space-y-2">
      <input id="newLogin" placeholder="Usu√°rio" class="border p-2 w-full" required />
      <input id="newPass" type="password" placeholder="Senha" class="border p-2 w-full" required />
      <select id="newRole" class="border p-2 w-full">
        <option value="admin">Administrador</option>
        <option value="user">Usu√°rio</option>
      </select>
      <div class="flex gap-2">
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Salvar</button>
        <button type="button" onclick="closeUserModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Cancelar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Configura√ß√µes -->
<div id="settingsModal" class="fixed inset-0 hidden bg-black bg-opacity-50 flex items-center justify-center">
  <div class="bg-white p-6 rounded-lg shadow-lg w-96">
    <h2 class="text-xl font-bold mb-4">Configura√ß√µes</h2>
    <form id="settingsForm" class="space-y-2">
      <input id="newOperator" placeholder="Novo T√©cnico" class="border p-2 w-full" />
      <div class="flex gap-2">
        <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Adicionar</button>
        <button type="button" onclick="closeSettingsModal()" class="px-4 py-2 bg-gray-400 text-white rounded">Fechar</button>
      </div>
    </form>
  </div>
</div>

<script type="module">
/* --- Firebase --- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBA16WHE768N9eUcqEoQqUF7uEIB82nNM0",
  authDomain: "chamados-37b34.firebaseapp.com",
  projectId: "chamados-37b34",
  storageBucket: "chamados-37b34.appspot.com",
  messagingSenderId: "164935126006",
  appId: "1:164935126006:web:e49fd19961993d5b62d5d7"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let tickets = [];
let operators = [];
let currentUser = null;
let editTicketId = null;

/* --- Expira√ß√£o do Sistema --- */
const EXPIRATION_DAYS = 30;
const startKey = "systemStartDate";
if (!localStorage.getItem(startKey)) {
  localStorage.setItem(startKey, Date.now());
}
function getRemainingDays() {
  const startDate = parseInt(localStorage.getItem(startKey), 10);
  const now = Date.now();
  const diffDays = Math.floor((now - startDate) / (1000 * 60 * 60 * 24));
  return EXPIRATION_DAYS - diffDays;
}
function isExpired() { return getRemainingDays() <= 0; }
function showExpirationNotice() {
  const notice = document.getElementById("expirationNotice");
  const remaining = getRemainingDays();
  if (remaining > 0) {
    notice.textContent = `‚è≥ Este sistema expira em ${remaining} dia(s).`;
    notice.classList.remove("hidden");
  } else {
    notice.textContent = "‚ö†Ô∏è O sistema expirou! Entre em contato com o administrador.";
    notice.classList.remove("hidden");
  }
}

/* --- Login --- */
async function loginUser(login, password){
  const snapshot = await getDocs(collection(db,"users"));
  const users = snapshot.docs.map(d=>({id:d.id,...d.data()}));
  return users.find(u=>u.login===login && u.password===password) || null;
}
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  if (isExpired()) {
    alert("‚ö†Ô∏è O sistema expirou! Entre em contato com o administrador.");
    return;
  }
  const login=document.getElementById("loginUser").value;
  const pass=document.getElementById("loginPass").value;
  const user = await loginUser(login, pass);
  if(user){
    currentUser=user;
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("systemScreen").classList.remove("hidden");
    if(user.role==="admin") document.getElementById("btnUserRegister").classList.remove("hidden");
    fetchOperators(); 
    fetchTickets();
    showExpirationNotice();
  } else alert("Usu√°rio ou senha inv√°lidos!");
});

/* --- Logout --- */
document.getElementById("btnLogout").addEventListener("click", ()=>{
  currentUser=null;
  document.getElementById("loginScreen").classList.remove("hidden");
  document.getElementById("systemScreen").classList.add("hidden");
});

/* --- Usu√°rios --- */
document.getElementById("btnUserRegister").addEventListener("click", ()=>{ document.getElementById("userModal").classList.remove("hidden"); });
function closeUserModal(){ document.getElementById("userModal").classList.add("hidden"); }
document.getElementById("userForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const login=document.getElementById("newLogin").value;
  const pass=document.getElementById("newPass").value;
  const role=document.getElementById("newRole").value;
  await addDoc(collection(db,"users"),{login,password:pass,role});
  alert("Usu√°rio cadastrado!");
  closeUserModal();
});

/* --- Configura√ß√µes (T√©cnicos) --- */
document.getElementById("btnSettings").addEventListener("click", ()=>{ document.getElementById("settingsModal").classList.remove("hidden"); });
function closeSettingsModal(){ document.getElementById("settingsModal").classList.add("hidden"); }
document.getElementById("settingsForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const name=document.getElementById("newOperator").value;
  if(name){
    await addDoc(collection(db,"operators"),{name});
    alert("T√©cnico adicionado!");
    fetchOperators();
    closeSettingsModal();
  }
});

/* --- Tickets --- */
async function fetchOperators(){
  const snapshot=await getDocs(collection(db,"operators"));
  operators=snapshot.docs.map(d=>({id:d.id,...d.data()}));
  const select=document.getElementById("tech");
  select.innerHTML="";
  operators.forEach(o=>{
    const opt=document.createElement("option");
    opt.value=o.name; opt.textContent=o.name;
    select.appendChild(opt);
  });
}
async function fetchTickets(){
  const q=query(collection(db,"tickets"),orderBy("created","desc"));
  const snapshot=await getDocs(q);
  tickets=snapshot.docs.map(d=>({id:d.id,...d.data()}));
  renderTickets();
}
function renderTickets(){
  const list=document.getElementById("ticketsList");
  list.innerHTML="";
  tickets.forEach(t=>{
    const tr=document.createElement("tr");
    if(t.priority==="critical" && t.status!=="Fechado") tr.classList.add("blink");
    tr.innerHTML=`
      <td class="border px-4 py-2">${t.subject}</td>
      <td class="border px-4 py-2">${t.client}</td>
      <td class="border px-4 py-2">${t.tech}</td>
      <td class="border px-4 py-2">${t.priority}</td>
      <td class="border px-4 py-2">${t.status||"Aberto"}</td>
      <td class="border px-4 py-2">
        <button class="btn-edit" onclick="editTicket('${t.id}')">Editar</button>
        <button class="btn-close" onclick="closeTicket('${t.id}')">Fechar</button>
        <button class="btn-details" onclick="alert('Descri√ß√£o: ${t.description||""}')">Detalhes</button>
      </td>`;
    list.appendChild(tr);
  });
}
document.getElementById("ticketForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const subject=document.getElementById("subject").value;
  const client=document.getElementById("client").value;
  const tech=document.getElementById("tech").value;
  const priority=document.getElementById("priority").value;
  const description=document.getElementById("description").value;
  if(editTicketId){
    const ref=doc(db,"tickets",editTicketId);
    await updateDoc(ref,{subject,client,tech,priority,description});
    alert("Chamado atualizado!");
    editTicketId=null;
    document.getElementById("cancelEditBtn").classList.add("hidden");
  } else {
    await addDoc(collection(db,"tickets"),{subject,client,tech,priority,description,status:"Aberto",created:Date.now()});
    alert("Chamado aberto!");
  }
  e.target.reset();
  fetchTickets();
});
window.editTicket=async function(id){
  const t=tickets.find(x=>x.id===id);
  if(t){
    document.getElementById("subject").value=t.subject;
    document.getElementById("client").value=t.client;
    document.getElementById("tech").value=t.tech;
    document.getElementById("priority").value=t.priority;
    document.getElementById("description").value=t.description||"";
    editTicketId=id;
    document.getElementById("cancelEditBtn").classList.remove("hidden");
  }
};
window.cancelEdit=function(){
  editTicketId=null;
  document.getElementById("ticketForm").reset();
  document.getElementById("cancelEditBtn").classList.add("hidden");
};
window.closeTicket=async function(id){
  const ref=doc(db,"tickets",id);
  await updateDoc(ref,{status:"Fechado"});
  alert("Chamado fechado!");
  fetchTickets();
};
</script>
</body>
</html>
