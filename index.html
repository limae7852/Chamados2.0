<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Chamados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  body { background-color:#121212; color:#f5f5f5; }
  .card{background-color:#1e1e1e; border:1px solid #333;}
  .navbar{background-color:#212121 !important;}
  .table-dark tbody tr td{vertical-align:middle;}
  .modal-content{background-color:#1e1e1e; color:#f5f5f5;}
  .btn-edit{background-color:#facc15;color:#000;padding:0.25rem 0.5rem;border-radius:0.25rem;}
  .btn-edit:hover{background-color:#eab308;}
  .btn-close{background-color:#ef4444;color:#fff;padding:0.25rem 0.5rem;border-radius:0.25rem;}
  .btn-close:hover{background-color:#b91c1c;}
  .btn-details{background-color:#3b82f6;color:#fff;padding:0.25rem 0.5rem;border-radius:0.25rem;}
  .btn-details:hover{background-color:#1d4ed8;}
</style>
</head>
<body>

<nav class="navbar navbar-dark mb-4">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">Painel de Chamados</span>
    <button id="logoutBtn" class="btn btn-outline-light btn-sm d-none">Sair</button>
  </div>
</nav>

<!-- Login -->
<div class="container" id="loginContainer">
  <div class="row justify-content-center">
    <div class="col-md-4">
      <div class="card p-4 shadow">
        <h4 class="text-center mb-3">Login</h4>
        <div class="mb-3"><label class="form-label">Usuário</label><input type="text" class="form-control" id="loginUser"></div>
        <div class="mb-3"><label class="form-label">Senha</label><input type="password" class="form-control" id="loginPass"></div>
        <button class="btn btn-primary w-100" id="loginBtn">Entrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Sistema -->
<div class="container d-none" id="mainContainer">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="bi bi-ticket-detailed"></i> Chamados</h3>
    <button id="btnUserRegister" class="btn btn-success btn-sm d-none">Cadastrar Usuário</button>
  </div>

  <div class="table-responsive mb-3">
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th>Assunto</th>
          <th>Cliente</th>
          <th>Descrição</th>
          <th>Técnico</th>
          <th>Prioridade</th>
          <th>Status</th>
          <th>Data</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody id="ticketTableBody"></tbody>
    </table>
  </div>

  <div class="mb-4">
    <button id="btnOperators" class="btn btn-info btn-sm">Gerenciar Operadores</button>
    <button id="btnReport" class="btn btn-warning btn-sm">Relatório PDF/Excel</button>
  </div>

</div>

<!-- Modal Usuários -->
<div class="modal fade" id="userModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="d-flex justify-content-between mb-2">
        <h5 class="modal-title">Cadastrar Usuário</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="userForm">
        <div class="mb-2"><input class="form-control" placeholder="Nome" id="userName" required></div>
        <div class="mb-2"><input class="form-control" placeholder="Login" id="userLogin" required></div>
        <div class="mb-2"><input type="password" class="form-control" placeholder="Senha" id="userPass" required></div>
        <div class="mb-2">
          <select id="userRole" class="form-control" required>
            <option value="admin">Admin</option>
            <option value="tech">Técnico</option>
            <option value="operator">Operador</option>
          </select>
        </div>
        <button type="submit" class="btn btn-success w-100">Salvar</button>
      </form>
      <ul id="usersList" class="mt-3 list-group list-group-flush"></ul>
    </div>
  </div>
</div>

<!-- Modal Operadores -->
<div class="modal fade" id="operatorsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="d-flex justify-content-between mb-2">
        <h5 class="modal-title">Operadores</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="d-flex mb-2">
        <input id="newOperator" class="form-control me-2" placeholder="Nome do Técnico">
        <button id="addOperatorBtn" class="btn btn-primary">Adicionar</button>
      </div>
      <ul id="operatorsList" class="list-group list-group-flush"></ul>
    </div>
  </div>
</div>

<!-- Modal Relatório -->
<div class="modal fade" id="reportModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content p-3">
      <div class="d-flex justify-content-between mb-2">
        <h5 class="modal-title">Relatório de Chamados</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="mb-2">
        <button onclick="downloadPDF()" class="btn btn-danger btn-sm">PDF</button>
        <button onclick="downloadExcel()" class="btn btn-success btn-sm">Excel</button>
      </div>
      <div id="reportContent"></div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // === FIREBASE ===
  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBA16WHE768N9eUcqEoQqUF7uEIB82nNM0",
    authDomain: "chamados-37b34.firebaseapp.com",
    projectId: "chamados-37b34",
    storageBucket: "chamados-37b34.firebasestorage.app",
    messagingSenderId: "164935126006",
    appId: "1:164935126006:web:e49fd19961993d5b62d5d7"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginContainer = document.getElementById("loginContainer");
  const mainContainer = document.getElementById("mainContainer");
  const ticketTableBody = document.getElementById("ticketTableBody");
  const btnUserRegister = document.getElementById("btnUserRegister");

  const userModal = new bootstrap.Modal(document.getElementById("userModal"));
  const operatorsModal = new bootstrap.Modal(document.getElementById("operatorsModal"));
  const reportModal = new bootstrap.Modal(document.getElementById("reportModal"));

  let currentUser = null;
  let tickets = [];

  // LOGIN
  loginBtn.addEventListener("click", async () => {
    const user = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    if(!user||!pass){alert("Preencha todos os campos!"); return;}
    const snapshot = await db.collection("users").where("login","==",user).where("password","==",pass).get();
    if(snapshot.empty){alert("Usuário ou senha incorretos!"); return;}
    currentUser = snapshot.docs[0].data();
    loginContainer.classList.add("d-none");
    mainContainer.classList.remove("d-none");
    logoutBtn.classList.remove("d-none");
    if(currentUser.role=="admin") btnUserRegister.classList.remove("d-none");
    carregarChamados();
  });

  // LOGOUT
  logoutBtn.addEventListener("click", ()=>{
    currentUser=null;
    loginContainer.classList.remove("d-none");
    mainContainer.classList.add("d-none");
    logoutBtn.classList.add("d-none");
  });

  // CARREGAR CHAMADOS
  async function carregarChamados(){
    ticketTableBody.innerHTML="<tr><td colspan='8' class='text-center'>Carregando...</td></tr>";
    const snapshot = await db.collection("tickets").orderBy("date","asc").get();
    tickets = snapshot.docs.map(d=>({id:d.id,...d.data()}));
    renderTickets();
  }

  function renderTickets(){
    if(tickets.length==0){ticketTableBody.innerHTML="<tr><td colspan='8'>Nenhum chamado.</td></tr>"; return;}
    ticketTableBody.innerHTML="";
    tickets.forEach(t=>{
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${t.subject||"-"}</td>
        <td>${t.client||"-"}</td>
        <td>${t.description||"-"}</td>
        <td>${t.tech||"-"}</td>
        <td>${t.priority||"-"}</td>
        <td>${t.status||"-"}</td>
        <td>${new Date(t.date).toLocaleString()}</td>
        <td><button class="btn-details btn btn-sm btn-primary" onclick="showDetails('${t.id}')">Detalhes</button></td>
      `;
      ticketTableBody.appendChild(row);
    });
  }

  // DETALHES
  window.showDetails = async function(id){
    const ticket = tickets.find(t=>t.id==id);
    if(!ticket) return;
    const content = document.getElementById("reportContent");
    content.innerHTML = `
      <p><strong>Assunto:</strong> ${ticket.subject}</p>
      <p><strong>Cliente:</strong> ${ticket.client}</p>
      <p><strong>Descrição:</strong> ${ticket.description}</p>
      <p><strong>Técnico:</strong> ${ticket.tech}</p>
      <p><strong>Prioridade:</strong> ${ticket.priority}</p>
      <p><strong>Status:</strong> ${ticket.status}</p>
      <p><strong>Data:</strong> ${new Date(ticket.date).toLocaleString()}</p>
    `;
    reportModal.show();
  }

  // RELATÓRIO
  document.getElementById("btnReport").addEventListener("click", ()=>{
    const content = document.getElementById("reportContent");
    if(tickets.length==0){content.innerHTML="<p>Nenhum chamado registrado.</p>"; reportModal.show(); return;}
    let html = `<table class="table table-dark table-striped"><thead><tr>
      <th>Assunto</th><th>Cliente</th><th>Descrição</th><th>Técnico</th><th>Prioridade</th><th>Status</th><th>Data</th>
    </tr></thead><tbody>`;
    tickets.forEach(t=>{
      html+=`<tr>
        <td>${t.subject}</td><td>${t.client}</td><td>${t.description}</td><td>${t.tech}</td>
        <td>${t.priority}</td><td>${t.status}</td><td>${new Date(t.date).toLocaleString()}</td>
      </tr>`;
    });
    html += "</tbody></table>";
    content.innerHTML = html;
    reportModal.show();
  });

  function downloadPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y=10;
    doc.text("Relatório de Chamados",10,y); y+=10;
    tickets.forEach(t=>{
      doc.text(`Assunto: ${t.subject}`,10,y); y+=6;
      doc.text(`Cliente: ${t.client}`,10,y); y+=6;
      doc.text(`Descrição: ${t.description}`,10,y); y+=6;
      doc.text(`Técnico: ${t.tech}`,10,y); y+=6;
      doc.text(`Prioridade: ${t.priority}`,10,y); y+=6;
      doc.text(`Status: ${t.status}`,10,y); y+=6;
      doc.text(`Data: ${new Date(t.date).toLocaleString()}`,10,y); y+=10;
    });
    doc.save("relatorio_chamados.pdf");
  }

  function downloadExcel(){
    const wb = XLSX.utils.book_new();
    const ws_data=[["Assunto","Cliente","Descrição","Técnico","Prioridade","Status","Data"]];
    tickets.forEach(t=>ws_data.push([t.subject,t.client,t.description,t.tech,t.priority,t.status,new Date(t.date).toLocaleString()]));
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb,ws,"Chamados");
    XLSX.writeFile(wb,"relatorio_chamados.xlsx");
  }

  // USUÁRIOS
  btnUserRegister.addEventListener("click",()=>userModal.show());
  document.getElementById("userForm").addEventListener("submit",async e=>{
    e.preventDefault();
    const newUser = {
      name: document.getElementById("userName").value,
      login: document.getElementById("userLogin").value,
      password: document.getElementById("userPass").value,
      role: document.getElementById("userRole").value
    };
    await db.collection("users").add(newUser);
    e.target.reset();
    fetchUsers();
  });
  async function fetchUsers(){
    const snapshot = await db.collection("users").get();
    const ul = document.getElementById("usersList"); ul.innerHTML="";
    snapshot.forEach(doc=>{
      const u = doc.data();
      const li = document.createElement("li");
      li.className="list-group-item bg-dark text-white";
      li.textContent = `${u.name} (${u.login}) - ${u.role}`;
      ul.appendChild(li);
    });
  }

  // OPERADORES
  document.getElementById("btnOperators").addEventListener("click",()=>operatorsModal.show());
  const operatorsList = document.getElementById("operatorsList");
  document.getElementById("addOperatorBtn").addEventListener("click",async ()=>{
    const name = document.getElementById("newOperator").value.trim();
    if(!name) return;
    await db.collection("operators").add({name});
    document.getElementById("newOperator").value="";
    fetchOperators();
  });
  async function fetchOperators(){
    const snapshot = await db.collection("operators").orderBy("name").get();
    operatorsList.innerHTML="";
    snapshot.forEach(doc=>{
      const op = doc.data();
      const li = document.createElement("li");
      li.className="list-group-item d-flex justify-content-between align-items-center bg-dark text-white";
      li.textContent=op.name;
      const btn = document.createElement("button");
      btn.className="btn btn-sm btn-danger";
      btn.textContent="Remover";
      btn.onclick=async()=>{await db.collection("operators").doc(doc.id).delete(); fetchOperators();}
      li.appendChild(btn);
      operatorsList.appendChild(li);
    });
  }

  // Inicial fetch
  fetchUsers();
  fetchOperators();

</script>
</body>
</html>
