<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Chamados</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">üìå Sistema de Chamados</h1>
    <button onclick="openConfig()" class="bg-gray-800 px-3 py-1 rounded">‚öôÔ∏è Configura√ß√µes</button>
  </header>

  <!-- Conte√∫do -->
  <main class="p-6 flex-1">
    <!-- Formul√°rio -->
    <div class="bg-white p-6 rounded shadow mb-6">
      <h2 class="text-lg font-bold mb-4">Abrir Chamado</h2>
      <form id="ticketForm" class="grid gap-3">
        <input type="text" id="title" placeholder="T√≠tulo" class="border p-2 rounded" required>
        <textarea id="description" placeholder="Descri√ß√£o do problema" class="border p-2 rounded" required></textarea>
        
        <select id="priority" class="border p-2 rounded" required>
          <option value="">Selecione prioridade</option>
          <option value="Baixa">Baixa</option>
          <option value="M√©dia">M√©dia</option>
          <option value="Alta">Alta</option>
          <option value="Cr√≠tica">Cr√≠tica</option>
        </select>

        <select id="tech" class="border p-2 rounded" required>
          <option value="">Selecione operador</option>
        </select>

        <button class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Abrir</button>
      </form>
    </div>

    <!-- Lista de chamados -->
    <div class="bg-white p-6 rounded shadow">
      <h2 class="text-lg font-bold mb-4">Chamados Abertos</h2>
      <table class="w-full border-collapse">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">T√≠tulo</th>
            <th class="p-2 border">Descri√ß√£o</th>
            <th class="p-2 border">Prioridade</th>
            <th class="p-2 border">Operador</th>
            <th class="p-2 border">Status</th>
            <th class="p-2 border">A√ß√µes</th>
          </tr>
        </thead>
        <tbody id="ticketsTable"></tbody>
      </table>
    </div>
  </main>

  <!-- Modal Configura√ß√µes -->
  <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96 shadow-xl max-h-[90vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">‚öôÔ∏è Configura√ß√µes</h2>

      <!-- Config Email -->
      <h3 class="text-lg font-semibold">EmailJS</h3>
      <input id="emailPublicKey" type="text" placeholder="Public Key" class="w-full border p-2 mb-2 rounded">
      <input id="emailServiceId" type="text" placeholder="Service ID" class="w-full border p-2 mb-2 rounded">
      <input id="emailTemplateId" type="text" placeholder="Template ID" class="w-full border p-2 mb-4 rounded">

      <!-- Config Banco -->
      <h3 class="text-lg font-semibold">Banco de Dados (Supabase)</h3>
      <input id="dbUrl" type="text" placeholder="Supabase URL" class="w-full border p-2 mb-2 rounded">
      <input id="dbKey" type="text" placeholder="Supabase Anon Key" class="w-full border p-2 mb-4 rounded">

      <!-- Config Operadores -->
      <h3 class="text-lg font-semibold">Operadores</h3>
      <div id="operatorList" class="mb-2"></div>
      <div class="flex gap-2">
        <input id="newOperator" type="text" placeholder="Nome do operador" class="flex-1 border p-2 rounded">
      </div>
      <div class="flex gap-2 mt-2">
        <input id="newOperatorEmail" type="email" placeholder="Email do operador" class="flex-1 border p-2 rounded">
        <button onclick="addOperator()" class="bg-blue-500 text-white px-3 py-2 rounded">+ Adicionar</button>
      </div>

      <!-- A√ß√µes -->
      <div class="flex justify-end mt-4 gap-2">
        <button onclick="closeConfig()" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
        <button onclick="saveConfig()" class="px-4 py-2 bg-green-600 text-white rounded">Salvar</button>
      </div>
    </div>
  </div>

<script>
// ==================== Supabase =====================
let supabaseClient;
function initSupabase() {
  const url = localStorage.getItem("dbUrl") || "https://YOUR_SUPABASE_URL.supabase.co";
  const key = localStorage.getItem("dbKey") || "YOUR_SUPABASE_ANON_KEY";
  supabaseClient = supabase.createClient(url, key);
}

// ==================== Configura√ß√µes =====================
function openConfig() {
  loadConfig();
  document.getElementById("configModal").classList.remove("hidden");
  document.getElementById("configModal").classList.add("flex");
}

function closeConfig() {
  document.getElementById("configModal").classList.add("hidden");
  document.getElementById("configModal").classList.remove("flex");
}

function saveConfig() {
  localStorage.setItem("emailPublicKey", document.getElementById("emailPublicKey").value);
  localStorage.setItem("emailServiceId", document.getElementById("emailServiceId").value);
  localStorage.setItem("emailTemplateId", document.getElementById("emailTemplateId").value);
  localStorage.setItem("dbUrl", document.getElementById("dbUrl").value);
  localStorage.setItem("dbKey", document.getElementById("dbKey").value);
  initSupabase();
  closeConfig();
  loadTickets();
}

function loadConfig() {
  document.getElementById("emailPublicKey").value = localStorage.getItem("emailPublicKey") || "";
  document.getElementById("emailServiceId").value = localStorage.getItem("emailServiceId") || "";
  document.getElementById("emailTemplateId").value = localStorage.getItem("emailTemplateId") || "";
  document.getElementById("dbUrl").value = localStorage.getItem("dbUrl") || "";
  document.getElementById("dbKey").value = localStorage.getItem("dbKey") || "";
  renderOperators();
}

// ==================== Operadores =====================
function addOperator() {
  const name = document.getElementById("newOperator").value.trim();
  const email = document.getElementById("newOperatorEmail").value.trim();
  if (!name || !email) return;
  let operators = JSON.parse(localStorage.getItem("operators") || "[]");
  operators.push({ name, email });
  localStorage.setItem("operators", JSON.stringify(operators));
  document.getElementById("newOperator").value = "";
  document.getElementById("newOperatorEmail").value = "";
  renderOperators();
  loadOperatorsSelect();
}

function renderOperators() {
  const operators = JSON.parse(localStorage.getItem("operators") || "[]");
  const list = document.getElementById("operatorList");
  list.innerHTML = "";
  operators.forEach((op, i) => {
    list.innerHTML += `
      <div class="flex justify-between items-center bg-gray-100 p-2 rounded mb-1">
        <span>${op.name} (${op.email})</span>
        <button onclick="removeOperator(${i})" class="text-red-500">‚úñ</button>
      </div>`;
  });
}

function removeOperator(index) {
  let operators = JSON.parse(localStorage.getItem("operators") || "[]");
  operators.splice(index, 1);
  localStorage.setItem("operators", JSON.stringify(operators));
  renderOperators();
  loadOperatorsSelect();
}

function loadOperatorsSelect() {
  const select = document.getElementById("tech");
  select.innerHTML = `<option value="">Selecione operador</option>`;
  const operators = JSON.parse(localStorage.getItem("operators") || "[]");
  operators.forEach(op => {
    const option = document.createElement("option");
    option.value = op.name;
    option.textContent = `${op.name} (${op.email})`;
    select.appendChild(option);
  });
}

// ==================== Tickets =====================
async function loadTickets() {
  if (!supabaseClient) return;
  const { data, error } = await supabaseClient.from("tickets").select("*").order("id", { ascending: false });
  if (error) return console.error(error);
  const table = document.getElementById("ticketsTable");
  table.innerHTML = "";
  data.forEach(t => {
    table.innerHTML += `
      <tr class="border">
        <td class="p-2 border">${t.title}</td>
        <td class="p-2 border">${t.description}</td>
        <td class="p-2 border">${t.priority}</td>
        <td class="p-2 border">${t.tech}</td>
        <td class="p-2 border">${t.status}</td>
        <td class="p-2 border">
          ${t.status === "Aberto" ? `<button onclick="closeTicket(${t.id})" class="bg-red-600 text-white px-2 py-1 rounded">Encerrar</button>` : ""}
        </td>
      </tr>`;
  });
}

document.getElementById("ticketForm").addEventListener("submit", async e => {
  e.preventDefault();
  const title = document.getElementById("title").value;
  const description = document.getElementById("description").value;
  const priority = document.getElementById("priority").value;
  const tech = document.getElementById("tech").value;

  const { error } = await supabaseClient.from("tickets").insert([{ title, description, priority, tech, status: "Aberto" }]);
  if (error) return alert("Erro ao abrir chamado");

  sendEmail("Novo chamado aberto", { title, description, priority, tech });
  e.target.reset();
  loadTickets();
});

async function closeTicket(id) {
  const { error } = await supabaseClient.from("tickets").update({ status: "Encerrado" }).eq("id", id);
  if (error) return alert("Erro ao encerrar chamado");

  sendEmail("Chamado encerrado", { id });
  loadTickets();
}

// ==================== Email =====================
function sendEmail(subject, data) {
  const publicKey = localStorage.getItem("emailPublicKey");
  const serviceId = localStorage.getItem("emailServiceId");
  const templateId = localStorage.getItem("emailTemplateId");
  if (!publicKey || !serviceId || !templateId) {
    console.warn("Configura√ß√µes de EmailJS n√£o definidas.");
    return;
  }
  emailjs.init(publicKey);
  emailjs.send(serviceId, templateId, { subject, ...data })
    .then(() => console.log("Email enviado"))
    .catch(err => console.error("Erro email:", err));
}

// ==================== Inicializa√ß√£o =====================
initSupabase();
loadOperatorsSelect();
loadTickets();
</script>
</body>
</html>
