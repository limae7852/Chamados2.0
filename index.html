<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistema de Chamados</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
  @keyframes blink {
    0%, 50%, 100% { background-color: #f87171; }
    25%, 75% { background-color: #fca5a5; }
  }
  .blink td { animation: blink 1s infinite; }
  .btn-edit { background-color: #facc15; color: #000; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
  .btn-edit:hover { background-color: #eab308; }
  .btn-close { background-color: #ef4444; color: #fff; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
  .btn-close:hover { background-color: #b91c1c; }
  .btn-details { background-color: #3b82f6; color: #fff; padding: 0.25rem 0.5rem; border-radius: 0.25rem; }
  .btn-details:hover { background-color: #1d4ed8; }
</style>
</head>
<body class="bg-gray-100 text-gray-900">

<!-- Tela de Login -->
<div id="loginScreen" class="flex justify-center items-center min-h-screen">
  <div class="bg-white shadow-lg rounded-lg p-8 w-96">
    <h1 class="text-2xl font-bold mb-4">Login</h1>
    <form id="loginForm" class="space-y-2">
      <input id="loginUser" placeholder="Usu√°rio" class="border p-2 w-full" required />
      <input id="loginPass" type="password" placeholder="Senha" class="border p-2 w-full" required />
      <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded w-full">Entrar</button>
    </form>
  </div>
</div>

<!-- Tela do Sistema -->
<div id="systemScreen" class="p-6 hidden">
  <div class="flex justify-between items-center mb-4">
    <h1 class="text-2xl font-bold">Sistema de Chamados</h1>
    <div>
      <button id="btnUserRegister" class="px-4 py-2 bg-green-600 text-white rounded hidden">Cadastrar Usu√°rio</button>
      <button id="btnLogout" class="px-4 py-2 bg-red-600 text-white rounded ml-2">Logout</button>
    </div>
  </div>

  <div class="flex gap-2 mb-4">
    <button id="btnSettings" class="px-4 py-2 bg-blue-600 text-white rounded">‚öôÔ∏è Configura√ß√µes</button>
    <button id="btnReport" class="px-4 py-2 bg-purple-600 text-white rounded">üìÑ Relat√≥rio</button>
  </div>

  <form id="ticketForm" class="mt-4 space-y-2">
    <input id="subject" placeholder="Assunto" class="border p-2 w-full" required />
    <input id="client" placeholder="Cliente" class="border p-2 w-full" required />
    <select id="tech" class="border p-2 w-full" required></select>
    <select id="priority" class="border p-2 w-full">
      <option value="low">Baixa</option>
      <option value="medium">M√©dia</option>
      <option value="high">Alta</option>
      <option value="critical">Cr√≠tica</option>
    </select>
    <textarea id="description" placeholder="Descri√ß√£o" class="border p-2 w-full"></textarea>
    <div class="flex gap-2">
      <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Abrir Chamado</button>
      <button type="button" id="cancelEditBtn" class="px-4 py-2 bg-red-500 text-white rounded hidden" onclick="cancelEdit()">Cancelar</button>
    </div>
  </form>

  <table class="mt-6 w-full border">
    <thead>
      <tr class="bg-gray-200">
        <th class="border px-4 py-2">Assunto</th>
        <th class="border px-4 py-2">Cliente</th>
        <th class="border px-4 py-2">T√©cnico</th>
        <th class="border px-4 py-2">Prioridade</th>
        <th class="border px-4 py-2">Status</th>
        <th class="border px-4 py-2">A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="ticketsList"></tbody>
  </table>
</div>

<!-- Modal Configura√ß√µes -->
<div id="modalSettings" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-bold">Configura√ß√µes - T√©cnicos</h2>
      <button id="closeSettingsBtn" class="text-red-600 font-bold">X</button>
    </div>
    <div class="flex space-x-2 mb-4">
      <input id="newOperator" placeholder="Nome do T√©cnico" class="border p-2 flex-1"/>
      <button id="addOperatorBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Adicionar</button>
    </div>
    <ul id="operatorsList" class="space-y-2"></ul>
  </div>
</div>

<!-- Modal Detalhes -->
<div id="detailsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-bold">Detalhes do Chamado</h2>
      <button onclick="closeDetailsModal()" class="text-red-600 font-bold">X</button>
    </div>
    <div id="detailsContent"></div>
  </div>
</div>

<!-- Modal Cadastro de Usu√°rio -->
<div id="userModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-bold">Cadastrar Usu√°rio</h2>
      <button onclick="closeUserModal()" class="text-red-600 font-bold">X</button>
    </div>
    <form id="userForm" class="space-y-2">
      <input id="userName" placeholder="Nome" class="border p-2 w-full" required />
      <input id="userLogin" placeholder="Login" class="border p-2 w-full" required />
      <input id="userPass" type="password" placeholder="Senha" class="border p-2 w-full" required />
      <select id="userRole" class="border p-2 w-full" required>
        <option value="admin">Admin</option>
        <option value="tech">T√©cnico</option>
        <option value="operator">Operador</option>
      </select>
      <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Salvar</button>
    </form>
    <ul id="usersList" class="mt-4 space-y-1"></ul>
  </div>
</div>

<!-- Modal Relat√≥rio -->
<div id="reportModal" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
  <div class="bg-white rounded-lg shadow-lg w-11/12 max-w-4xl p-6 overflow-y-auto max-h-[80vh]">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-bold">Relat√≥rio de Chamados</h2>
      <button id="closeReportBtn" class="text-red-600 font-bold px-2 py-1 rounded border border-red-600 hover:bg-red-100">X</button>
    </div>
    <div class="flex gap-2 mb-4">
      <button onclick="downloadPDF()" class="px-4 py-2 bg-red-600 text-white rounded">üìÑ PDF</button>
      <button onclick="downloadExcel()" class="px-4 py-2 bg-green-600 text-white rounded">üìä Excel</button>
    </div>
    <div id="reportContent"></div>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBA16WHE768N9eUcqEoQqUF7uEIB82nNM0",
  authDomain: "chamados-37b34.firebaseapp.com",
  projectId: "chamados-37b34",
  storageBucket: "chamados-37b34.appspot.com",
  messagingSenderId: "164935126006",
  appId: "1:164935126006:web:e49fd19961993d5b62d5d7"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let tickets = [];
let operators = [];
let currentUser = null;
let editTicketId = null;

/* --- Login --- */
async function loginUser(login, password){
  const snapshot = await getDocs(collection(db,"users"));
  const users = snapshot.docs.map(d=>({id:d.id,...d.data()}));
  return users.find(u=>u.login===login && u.password===password) || null;
}
document.getElementById("loginForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const login=document.getElementById("loginUser").value;
  const pass=document.getElementById("loginPass").value;
  const user = await loginUser(login, pass);
  if(user){
    currentUser=user;
    document.getElementById("loginScreen").classList.add("hidden");
    document.getElementById("systemScreen").classList.remove("hidden");
    if(user.role==="admin") document.getElementById("btnUserRegister").classList.remove("hidden");
    fetchOperators(); fetchTickets();
  } else alert("Usu√°rio ou senha inv√°lidos!");
});

/* --- Logout --- */
document.getElementById("btnLogout").addEventListener("click", ()=>{
  currentUser=null;
  document.getElementById("loginScreen").classList.remove("hidden");
  document.getElementById("systemScreen").classList.add("hidden");
});

/* --- Cadastro Usu√°rio --- */
const userModal=document.getElementById("userModal");
function openUserModal(){ userModal.classList.remove("hidden"); userModal.classList.add("flex"); }
function closeUserModal(){ userModal.classList.add("hidden"); userModal.classList.remove("flex"); }
window.openUserModal=openUserModal; window.closeUserModal=closeUserModal;
document.getElementById("btnUserRegister").addEventListener("click", openUserModal);
document.getElementById("userForm").addEventListener("submit", async e=>{
  e.preventDefault();
  const newUser={
    name:document.getElementById("userName").value,
    login:document.getElementById("userLogin").value,
    password:document.getElementById("userPass").value,
    role:document.getElementById("userRole").value
  };
  await addDoc(collection(db,"users"), newUser);
  e.target.reset();
  fetchUsers();
});
async function fetchUsers(){
  const snapshot=await getDocs(collection(db,"users"));
  const users=snapshot.docs.map(d=>({id:d.id,...d.data()}));
  const ul=document.getElementById("usersList"); ul.innerHTML="";
  users.forEach(u=>{ const li=document.createElement("li"); li.textContent=`${u.name} (${u.login}) - ${u.role}`; ul.appendChild(li); });
}

/* --- Operadores --- */
const btnSettings=document.getElementById("btnSettings");
const modalSettings=document.getElementById("modalSettings");
const closeSettingsBtn=document.getElementById("closeSettingsBtn");
const operatorsListEl=document.getElementById("operatorsList");
const addOperatorBtn=document.getElementById("addOperatorBtn");
const techSelect=document.getElementById("tech");

btnSettings.addEventListener("click", ()=>{ modalSettings.classList.remove("hidden"); modalSettings.classList.add("flex"); });
closeSettingsBtn.addEventListener("click", ()=>{ modalSettings.classList.add("hidden"); modalSettings.classList.remove("flex"); });

async function fetchOperators(){
  const q=query(collection(db,"operators"),orderBy("name"));
  const snapshot=await getDocs(q);
  operators=snapshot.docs.map(d=>({id:d.id,...d.data()}));
  renderOperators();
}
function renderOperators(){
  operatorsListEl.innerHTML="";
  techSelect.innerHTML='<option value="">Selecione o T√©cnico</option>';
  operators.forEach(op=>{
    const li=document.createElement("li");
    li.className="flex justify-between items-center border p-2 rounded";
    li.innerHTML=`<span>${op.name}</span><button data-id="${op.id}" class="text-red-600 hover:underline">Remover</button>`;
    operatorsListEl.appendChild(li);
    const opt=document.createElement("option"); opt.value=op.name; opt.textContent=op.name; techSelect.appendChild(opt);
  });
}
addOperatorBtn.addEventListener("click", async ()=>{
  const input=document.getElementById("newOperator");
  const name=input.value.trim();
  if(name){ await addDoc(collection(db,"operators"), {name}); input.value=""; fetchOperators(); }
});
operatorsListEl.addEventListener("click", async e=>{
  const btn=e.target.closest("button[data-id]");
  if(btn){ await deleteDoc(doc(db,"operators",btn.dataset.id)); fetchOperators(); }
});

/* --- Tickets --- */
const ticketForm=document.getElementById("ticketForm");
ticketForm.addEventListener("submit", async e=>{
  e.preventDefault();
  const subject=document.getElementById("subject").value.trim();
  const client=document.getElementById("client").value.trim();
  const tech=document.getElementById("tech").value;
  const priority=document.getElementById("priority").value;
  const description=document.getElementById("description").value.trim();
  if(!subject || !client || !tech){ alert("Preencha todos os campos obrigat√≥rios!"); return; }

  const ticketData={subject,client,tech,priority,description,status:"open",date:Date.now()};

  try{
    if(editTicketId){ await updateDoc(doc(db,"tickets",editTicketId),ticketData); editTicketId=null; cancelEdit(); }
    else await addDoc(collection(db,"tickets"),ticketData);
    ticketForm.reset(); fetchTickets();
  }catch(err){ console.error("Erro ao salvar chamado:", err); alert("N√£o foi poss√≠vel salvar o chamado."); }
});

async function fetchTickets(){
  const q=query(collection(db,"tickets"),orderBy("date"));
  const snapshot=await getDocs(q);
  tickets=snapshot.docs.map(d=>({id:d.id,...d.data()}));
  renderTickets();
}
function translatePriority(p){ return {low:"Baixa",medium:"M√©dia",high:"Alta",critical:"Cr√≠tica"}[p]||p; }
function translateStatus(s){ return {open:"Aberto",resolved:"Encerrado"}[s]||s; }
function renderTickets(){
  const ticketsList=document.getElementById("ticketsList"); ticketsList.innerHTML="";
  tickets.forEach(ticket=>{
    const tr=document.createElement("tr"); tr.dataset.id=ticket.id;
    if(ticket.priority==="critical" && ticket.status!=="resolved") tr.classList.add("blink");
    const actionsHTML=ticket.status==="resolved"
      ? `<button class="details-btn btn-details">Detalhes</button> ‚úÖ Encerrado`
      : `<button class="edit-btn btn-edit">Editar</button><button class="close-btn btn-close">Encerrar</button><button class="details-btn btn-details">Detalhes</button>`;
    tr.innerHTML=`
      <td class="border px-4 py-2">${ticket.subject}</td>
      <td class="border px-4 py-2">${ticket.client}</td>
      <td class="border px-4 py-2">${ticket.tech}</td>
      <td class="border px-4 py-2 capitalize">${translatePriority(ticket.priority)}</td>
      <td class="border px-4 py-2 capitalize">${translateStatus(ticket.status)}</td>
      <td class="border px-4 py-2 space-x-2">${actionsHTML}</td>
    `;
    ticketsList.appendChild(tr);
  });
}

document.getElementById("ticketsList").addEventListener("click", e=>{
  const tr=e.target.closest("tr"); const id=tr?.dataset.id; if(!id) return;
  if(e.target.classList.contains("edit-btn")) editTicket(id);
  else if(e.target.classList.contains("close-btn")) closeTicket(id);
  else if(e.target.classList.contains("details-btn")) showDetails(id);
});

async function closeTicket(id){ await updateDoc(doc(db,"tickets",id),{status:"resolved"}); fetchTickets(); cancelEdit(); }

function editTicket(id){
  const ticket=tickets.find(t=>t.id===id); if(!ticket || ticket.status==="resolved") return;
  editTicketId=id;
  document.getElementById("subject").value=ticket.subject;
  document.getElementById("client").value=ticket.client;
  document.getElementById("tech").value=ticket.tech;
  document.getElementById("priority").value=ticket.priority;
  document.getElementById("description").value=ticket.description;
  document.getElementById("cancelEditBtn").classList.remove("hidden");
}
function cancelEdit(){ editTicketId=null; ticketForm.reset(); document.getElementById("cancelEditBtn").classList.add("hidden"); }
window.cancelEdit=cancelEdit;

function showDetails(id){
  const ticket=tickets.find(t=>t.id===id); if(!ticket) return;
  const content=document.getElementById("detailsContent");
  content.innerHTML=`
    <p><strong>ID:</strong> ${ticket.id}</p>
    <p><strong>Assunto:</strong> ${ticket.subject}</p>
    <p><strong>Descri√ß√£o:</strong> ${ticket.description}</p>
    <p><strong>Cliente:</strong> ${ticket.client}</p>
    <p><strong>T√©cnico:</strong> ${ticket.tech}</p>
    <p><strong>Prioridade:</strong> ${translatePriority(ticket.priority)}</p>
    <p><strong>Status:</strong> ${translateStatus(ticket.status)}</p>
    <p><strong>Abertura:</strong> ${new Date(ticket.date).toLocaleString()}</p>
  `;
  document.getElementById("detailsModal").classList.remove("hidden"); document.getElementById("detailsModal").classList.add("flex");
}
window.closeDetailsModal=function(){ document.getElementById("detailsModal").classList.add("hidden"); document.getElementById("detailsModal").classList.remove("flex"); }

/* --- Relat√≥rio --- */
const reportModal = document.getElementById("reportModal");
const reportContent = document.getElementById("reportContent");
document.getElementById("btnReport").addEventListener("click", ()=>{
  if(tickets.length === 0){
    reportContent.innerHTML = "<p>Nenhum chamado registrado.</p>";
  } else {
    let html = `<table class="w-full border text-left"><thead><tr class="bg-gray-200">
      <th class="border px-2 py-1">Assunto</th>
      <th class="border px-2 py-1">Cliente</th>
      <th class="border px-2 py-1">T√©cnico</th>
      <th class="border px-2 py-1">Prioridade</th>
      <th class="border px-2 py-1">Status</th>
      <th class="border px-2 py-1">Abertura</th>
    </tr></thead><tbody>`;
    tickets.forEach(t=>{
      html+=`<tr>
        <td class="border px-2 py-1">${t.subject}</td>
        <td class="border px-2 py-1">${t.client}</td>
        <td class="border px-2 py-1">${t.tech}</td>
        <td class="border px-2 py-1">${translatePriority(t.priority)}</td>
        <td class="border px-2 py-1">${translateStatus(t.status)}</td>
        <td class="border px-2 py-1">${new Date(t.date).toLocaleString()}</td>
      </tr>`;
    });
    html += `</tbody></table>`;
    reportContent.innerHTML = html;
  }
  reportModal.classList.remove("hidden"); 
  reportModal.classList.add("flex");
});

document.getElementById("closeReportBtn").addEventListener("click", ()=>{
  reportModal.classList.add("hidden"); 
  reportModal.classList.remove("flex");
});

// Fun√ß√µes PDF/Excel
function downloadPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Relat√≥rio de Chamados", 10, 10);
  let y = 20;
  tickets.forEach(t=>{
    doc.text(`Assunto: ${t.subject}`, 10, y); y+=6;
    doc.text(`Cliente: ${t.client}`, 10, y); y+=6;
    doc.text(`T√©cnico: ${t.tech}`, 10, y); y+=6;
    doc.text(`Prioridade: ${translatePriority(t.priority)}`, 10, y); y+=6;
    doc.text(`Status: ${translateStatus(t.status)}`, 10, y); y+=6;
    doc.text(`Abertura: ${new Date(t.date).toLocaleString()}`, 10, y); y+=10;
  });
  doc.save("relatorio_chamados.pdf");
}

function downloadExcel(){
  const wb = XLSX.utils.book_new();
  const ws_data=[["Assunto","Cliente","T√©cnico","Prioridade","Status","Abertura"]];
  tickets.forEach(t=>{
    ws_data.push([t.subject,t.client,t.tech,translatePriority(t.priority),translateStatus(t.status),new Date(t.date).toLocaleString()]);
  });
  const ws = XLSX.utils.aoa_to_sheet(ws_data);
  XLSX.utils.book_append_sheet(wb,ws,"Chamados");
  XLSX.writeFile(wb,"relatorio_chamados.xlsx");
}

</script>
</body>
</html>
