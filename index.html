<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistema de Chamados</title>
<script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

<div class="p-6">
  <h1 class="text-2xl font-bold mb-4">Sistema de Chamados</h1>

  <!-- Bot√£o Configura√ß√µes -->
  <button id="btnSettings" class="px-4 py-2 bg-blue-600 text-white rounded">‚öôÔ∏è Configura√ß√µes</button>

  <!-- Formul√°rio de Chamados -->
  <form id="ticketForm" class="mt-4 space-y-2">
    <input id="subject" placeholder="Assunto" class="border p-2 w-full" required />
    <input id="client" placeholder="Cliente" class="border p-2 w-full" required />
    <select id="tech" class="border p-2 w-full"></select>
    <select id="priority" class="border p-2 w-full">
      <option value="low">Baixa</option>
      <option value="medium">M√©dia</option>
      <option value="high">Alta</option>
      <option value="critical">Cr√≠tica</option>
    </select>
    <textarea id="description" placeholder="Descri√ß√£o" class="border p-2 w-full"></textarea>
    <div class="flex gap-2">
      <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Abrir Chamado</button>
      <button type="button" id="cancelEditBtn" class="px-4 py-2 bg-red-500 text-white rounded hidden" onclick="cancelEdit()">Cancelar</button>
    </div>
  </form>

  <!-- Tabela de Tickets -->
  <table class="mt-6 w-full border">
    <thead>
      <tr class="bg-gray-200">
        <th class="border px-4 py-2">ID</th>
        <th class="border px-4 py-2">Assunto</th>
        <th class="border px-4 py-2">Cliente</th>
        <th class="border px-4 py-2">T√©cnico</th>
        <th class="border px-4 py-2">Prioridade</th>
        <th class="border px-4 py-2">Status</th>
        <th class="border px-4 py-2">A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="ticketsList"></tbody>
  </table>
</div>

<!-- Modal Configura√ß√µes -->
<div id="modalSettings" class="fixed inset-0 bg-black bg-opacity-50 hidden justify-center items-center">
  <div class="bg-white rounded-lg shadow-lg w-96 p-6">
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-lg font-bold">Configura√ß√µes - T√©cnicos</h2>
      <button id="closeSettingsBtn" class="text-red-600 font-bold">X</button>
    </div>
    <div class="flex space-x-2 mb-4">
      <input id="newOperator" placeholder="Nome do T√©cnico" class="border p-2 flex-1"/>
      <button id="addOperatorBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Adicionar</button>
    </div>
    <ul id="operatorsList" class="space-y-2"></ul>
  </div>
</div>

<!-- üîπ Script Firebase -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, orderBy, query } 
    from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // Configura√ß√£o Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBA16WHE768N9eUcqEoQqUF7uEIB82nNM0",
    authDomain: "chamados-37b34.firebaseapp.com",
    projectId: "chamados-37b34",
    storageBucket: "chamados-37b34.appspot.com",
    messagingSenderId: "164935126006",
    appId: "1:164935126006:web:e49fd19961993d5b62d5d7"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  let tickets = [];
  let operators = [];
  let editTicketId = null;

  // ====== MODAL CONFIGURA√á√ïES ======
  const btnSettings = document.getElementById("btnSettings");
  const modalSettings = document.getElementById("modalSettings");
  const closeSettingsBtn = document.getElementById("closeSettingsBtn");
  const operatorsListEl = document.getElementById("operatorsList");
  const addOperatorBtn = document.getElementById("addOperatorBtn");
  const techSelect = document.getElementById("tech");

  btnSettings.addEventListener("click", ()=>{ modalSettings.classList.remove("hidden"); modalSettings.classList.add("flex"); });
  closeSettingsBtn.addEventListener("click", ()=>{ modalSettings.classList.add("hidden"); modalSettings.classList.remove("flex"); });
  modalSettings.addEventListener("click", (e) => { if(e.target===modalSettings) modalSettings.classList.add("hidden"); });

  // ====== OPERATORS ======
  async function fetchOperators(){
    const q = query(collection(db, "operators"), orderBy("name"));
    const snapshot = await getDocs(q);
    operators = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderOperators();
  }

  function renderOperators(){
    operatorsListEl.innerHTML = "";
    techSelect.innerHTML = '<option value="">Selecione o T√©cnico</option>';
    operators.forEach(op=>{
      const li = document.createElement("li");
      li.className = "flex justify-between items-center border p-2 rounded";
      li.innerHTML = `<span>${op.name}</span> 
        <button data-id="${op.id}" class="text-red-600 hover:underline">Remover</button>`;
      operatorsListEl.appendChild(li);

      const opt = document.createElement("option");
      opt.value = op.name; opt.textContent = op.name;
      techSelect.appendChild(opt);
    });
  }

  async function addOperator(name){
    await addDoc(collection(db, "operators"), { name });
    fetchOperators();
  }

  async function removeOperator(id){
    await deleteDoc(doc(db, "operators", id));
    fetchOperators();
  }

  addOperatorBtn.addEventListener("click", ()=>{
    const input = document.getElementById("newOperator");
    const name = input.value.trim();
    if(name){ addOperator(name); input.value = ""; }
  });

  operatorsListEl.addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-id]");
    if(btn) removeOperator(btn.dataset.id);
  });

  // ====== TICKETS ======
  async function fetchTickets(){
    const q = query(collection(db, "tickets"), orderBy("date"));
    const snapshot = await getDocs(q);
    tickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    renderTickets();
  }

  function renderTickets(){
    const ticketsList = document.getElementById("ticketsList");
    ticketsList.innerHTML = "";
    tickets.forEach(ticket=>{
      const tr = document.createElement("tr");
      tr.dataset.id = ticket.id;
      tr.innerHTML = `
        <td class="border px-4 py-2">${ticket.id}</td>
        <td class="border px-4 py-2">${ticket.subject}</td>
        <td class="border px-4 py-2">${ticket.client}</td>
        <td class="border px-4 py-2">${ticket.tech}</td>
        <td class="border px-4 py-2 capitalize">${ticket.priority}</td>
        <td class="border px-4 py-2 capitalize">${ticket.status}</td>
        <td class="border px-4 py-2 space-x-2">
          ${ticket.status !== "resolved" 
            ? `<button class="edit-btn text-yellow-600 hover:underline">Editar</button>
               <button class="close-btn text-green-600 hover:underline">Encerrar</button>`
            : "‚úÖ Encerrado"}
        </td>`;
      ticketsList.appendChild(tr);
    });
  }

  document.getElementById("ticketsList").addEventListener("click", (e)=>{
    const tr = e.target.closest("tr");
    const ticketId = tr?.dataset.id;
    if(!ticketId) return;
    if(e.target.classList.contains("edit-btn")) editTicket(ticketId);
    else if(e.target.classList.contains("close-btn")) closeTicket(ticketId);
  });

  async function addTicket(ticket){
    if(editTicketId){
      await updateDoc(doc(db, "tickets", editTicketId), ticket);
      editTicketId = null;
      cancelEdit();
    } else {
      await addDoc(collection(db, "tickets"), ticket);
    }
    fetchTickets();
  }

  async function closeTicket(id){
    await updateDoc(doc(db, "tickets", id), { status:'resolved' });
    fetchTickets();
    cancelEdit(); // remove edi√ß√£o se estiver ativa
  }

  // ====== EDITAR ======
  function editTicket(id){
    const ticket = tickets.find(t => t.id===id);
    if(!ticket || ticket.status==="resolved") return;
    editTicketId = id;
    document.getElementById("subject").value = ticket.subject;
    document.getElementById("client").value = ticket.client;
    document.getElementById("tech").value = ticket.tech;
    document.getElementById("priority").value = ticket.priority;
    document.getElementById("description").value = ticket.description;
    document.getElementById("cancelEditBtn").classList.remove("hidden");
  }

  function cancelEdit(){
    editTicketId = null;
    ticketForm.reset();
    document.getElementById("cancelEditBtn").classList.add("hidden");
  }
  window.cancelEdit = cancelEdit;

  // ====== FORM ======
  const ticketForm = document.getElementById("ticketForm");
  ticketForm.addEventListener("submit", (e)=>{
    e.preventDefault();
    const ticket = {
      subject: document.getElementById("subject").value,
      client: document.getElementById("client").value,
      tech: document.getElementById("tech").value,
      priority: document.getElementById("priority").value,
      description: document.getElementById("description").value,
      status: "open",
      date: new Date().toISOString()
    };
    addTicket(ticket);
    ticketForm.reset();
  });

  // ====== INICIALIZA√á√ÉO ======
  fetchOperators();
  fetchTickets();
</script>
</body>
</html>
