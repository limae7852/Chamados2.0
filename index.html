<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Sistema de Chamados</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
<style>
  body { background-color:#121212; color:#f5f5f5; }
  .card{background-color:#1e1e1e; border:1px solid #333;}
  .navbar{background-color:#212121 !important;}
  .table-dark tbody tr td{vertical-align:middle;}
  .modal-content{background-color:#1e1e1e; color:#f5f5f5;}
</style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-dark mb-4">
  <div class="container-fluid">
    <span class="navbar-brand mb-0 h1">Painel de Chamados</span>
    <button id="logoutBtn" class="btn btn-outline-light btn-sm d-none">Sair</button>
  </div>
</nav>

<!-- Login -->
<div class="container" id="loginContainer">
  <div class="row justify-content-center">
    <div class="col-md-4">
      <div class="card p-4 shadow">
        <h4 class="text-center mb-3">Login</h4>
        <div class="mb-3"><label class="form-label">Usuário</label><input type="text" class="form-control" id="loginUser"></div>
        <div class="mb-3"><label class="form-label">Senha</label><input type="password" class="form-control" id="loginPass"></div>
        <button class="btn btn-primary w-100" id="loginBtn">Entrar</button>
      </div>
    </div>
  </div>
</div>

<!-- Sistema -->
<div class="container d-none" id="mainContainer">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3><i class="bi bi-ticket-detailed"></i> Chamados</h3>
    <button id="btnUserRegister" class="btn btn-success btn-sm d-none">Cadastrar Usuário</button>
  </div>

  <div class="table-responsive mb-4">
    <table class="table table-dark table-striped align-middle">
      <thead>
        <tr>
          <th>Assunto</th>
          <th>Cliente</th>
          <th>Descrição</th>
          <th>Técnico</th>
          <th>Prioridade</th>
          <th>Status</th>
          <th>Data</th>
        </tr>
      </thead>
      <tbody id="ticketTableBody"></tbody>
    </table>
  </div>

  <button id="btnOperators" class="btn btn-info btn-sm mb-4">Gerenciar Operadores</button>

</div>

<!-- Modal Usuários -->
<div class="modal fade" id="userModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="d-flex justify-content-between mb-2">
        <h5 class="modal-title">Cadastrar Usuário</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <form id="userForm">
        <div class="mb-2"><input class="form-control" placeholder="Nome" id="userName" required></div>
        <div class="mb-2"><input class="form-control" placeholder="Login" id="userLogin" required></div>
        <div class="mb-2"><input type="password" class="form-control" placeholder="Senha" id="userPass" required></div>
        <div class="mb-2">
          <select id="userRole" class="form-control" required>
            <option value="admin">Admin</option>
            <option value="tech">Técnico</option>
            <option value="operator">Operador</option>
          </select>
        </div>
        <button type="submit" class="btn btn-success w-100">Salvar</button>
      </form>
      <ul id="usersList" class="mt-3 list-group list-group-flush"></ul>
    </div>
  </div>
</div>

<!-- Modal Operadores -->
<div class="modal fade" id="operatorsModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="d-flex justify-content-between mb-2">
        <h5 class="modal-title">Operadores</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="d-flex mb-2">
        <input id="newOperator" class="form-control me-2" placeholder="Nome do Técnico">
        <button id="addOperatorBtn" class="btn btn-primary">Adicionar</button>
      </div>
      <ul id="operatorsList" class="list-group list-group-flush"></ul>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Firebase
  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "SEU_AUTH_DOMAIN",
    projectId: "SEU_PROJECT_ID",
    storageBucket: "SEU_STORAGE_BUCKET",
    messagingSenderId: "SEU_SENDER_ID",
    appId: "SEU_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const loginBtn = document.getElementById("loginBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const loginContainer = document.getElementById("loginContainer");
  const mainContainer = document.getElementById("mainContainer");
  const ticketTableBody = document.getElementById("ticketTableBody");

  const btnUserRegister = document.getElementById("btnUserRegister");
  const userModal = new bootstrap.Modal(document.getElementById("userModal"));
  const operatorsModal = new bootstrap.Modal(document.getElementById("operatorsModal"));

  let currentUser = null;

  // LOGIN
  loginBtn.addEventListener("click", async () => {
    const user = document.getElementById("loginUser").value.trim();
    const pass = document.getElementById("loginPass").value.trim();
    if(!user||!pass){alert("Preencha todos os campos!");return;}
    try{
      const snapshot = await db.collection("users").where("login","==",user).where("password","==",pass).get();
      if(snapshot.empty){alert("Usuário ou senha incorretos!"); return;}
      currentUser = snapshot.docs[0].data();
      loginContainer.classList.add("d-none");
      mainContainer.classList.remove("d-none");
      logoutBtn.classList.remove("d-none");
      if(currentUser.role=="admin") btnUserRegister.classList.remove("d-none");
      carregarChamados();
    }catch(err){console.error(err);alert("Erro no login");}
  });

  // LOGOUT
  logoutBtn.addEventListener("click", ()=>{
    currentUser=null;
    loginContainer.classList.remove("d-none");
    mainContainer.classList.add("d-none");
    logoutBtn.classList.add("d-none");
  });

  // CARREGAR CHAMADOS
  async function carregarChamados(){
    ticketTableBody.innerHTML="<tr><td colspan='7' class='text-center'>Carregando...</td></tr>";
    try{
      const snapshot = await db.collection("tickets").orderBy("date","asc").get();
      if(snapshot.empty){ticketTableBody.innerHTML="<tr><td colspan='7' class='text-center text-muted'>Nenhum chamado.</td></tr>"; return;}
      ticketTableBody.innerHTML="";
      snapshot.forEach(doc=>{
        const t = doc.data();
        const data = new Date(t.date).toLocaleString("pt-BR");
        const row = `<tr>
          <td>${t.subject||"-"}</td>
          <td>${t.client||"-"}</td>
          <td>${t.description||"-"}</td>
          <td>${t.tech||"-"}</td>
          <td>${t.priority||"-"}</td>
          <td>${t.status||"-"}</td>
          <td>${data}</td>
        </tr>`;
        ticketTableBody.innerHTML+=row;
      });
    }catch(err){console.error(err);ticketTableBody.innerHTML="<tr><td colspan='7'>Erro ao carregar chamados</td></tr>";}
  }

  // USUÁRIOS
  btnUserRegister.addEventListener("click",()=>userModal.show());
  document.getElementById("userForm").addEventListener("submit",async e=>{
    e.preventDefault();
    const newUser={
      name: document.getElementById("userName").value,
      login: document.getElementById("userLogin").value,
      password: document.getElementById("userPass").value,
      role: document.getElementById("userRole").value
    };
    await db.collection("users").add(newUser);
    e.target.reset();
    fetchUsers();
  });
  async function fetchUsers(){
    const snapshot = await db.collection("users").get();
    const ul = document.getElementById("usersList");
    ul.innerHTML="";
    snapshot.forEach(doc=>{
      const u=doc.data();
      const li=document.createElement("li");
      li.className="list-group-item bg-dark text-white";
      li.textContent=`${u.name} (${u.login}) - ${u.role}`;
      ul.appendChild(li);
    });
  }

  // OPERADORES
  document.getElementById("btnOperators").addEventListener("click",()=>operatorsModal.show());
  const operatorsList = document.getElementById("operatorsList");
  document.getElementById("addOperatorBtn").addEventListener("click",async ()=>{
    const name = document.getElementById("newOperator").value.trim();
    if(!name) return;
    await db.collection("operators").add({name});
    document.getElementById("newOperator").value="";
    fetchOperators();
  });
  async function fetchOperators(){
    const snapshot = await db.collection("operators").orderBy("name").get();
    operatorsList.innerHTML="";
    snapshot.forEach(doc=>{
      const op = doc.data();
      const li = document.createElement("li");
      li.className="list-group-item d-flex justify-content-between align-items-center bg-dark text-white";
      li.textContent=op.name;
      const btn = document.createElement("button");
      btn.className="btn btn-sm btn-danger";
      btn.textContent="Remover";
      btn.onclick=async()=>{await db.collection("operators").doc(doc.id).delete(); fetchOperators();}
      li.appendChild(btn);
      operatorsList.appendChild(li);
    });
  }

  // Inicial fetch
  fetchUsers();
  fetchOperators();

</script>
</body>
</html>
