<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Chamados</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Navbar -->
  <div class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">üìå Sistema de Chamados</h1>
    <button onclick="openConfig()" class="bg-white text-blue-600 px-4 py-2 rounded">‚öôÔ∏è Configura√ß√µes</button>
  </div>

  <!-- Conte√∫do -->
  <div class="p-6">
    <button onclick="openModal()" class="mb-4 bg-green-600 text-white px-4 py-2 rounded">+ Novo Chamado</button>

    <!-- Tabela de chamados -->
    <table class="w-full border bg-white shadow-md rounded-lg overflow-hidden">
      <thead class="bg-gray-200">
        <tr>
          <th class="p-2 border">ID</th>
          <th class="p-2 border">T√≠tulo</th>
          <th class="p-2 border">Descri√ß√£o</th>
          <th class="p-2 border">Operador</th>
          <th class="p-2 border">Status</th>
          <th class="p-2 border">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="ticketTable"></tbody>
    </table>
  </div>

  <!-- Modal Novo Chamado -->
  <div id="ticketModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96 shadow-xl">
      <h2 class="text-xl font-bold mb-4">Novo Chamado</h2>
      <input id="ticketTitle" type="text" placeholder="T√≠tulo" class="w-full border p-2 mb-2 rounded">
      <textarea id="ticketDesc" placeholder="Descri√ß√£o" class="w-full border p-2 mb-2 rounded"></textarea>
      <select id="ticketOperator" class="w-full border p-2 mb-4 rounded"></select>
      <div class="flex justify-end gap-2">
        <button onclick="closeModal()" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
        <button onclick="createTicket()" class="px-4 py-2 bg-green-600 text-white rounded">Salvar</button>
      </div>
    </div>
  </div>

  <!-- Modal Configura√ß√µes -->
  <div id="configModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center">
    <div class="bg-white p-6 rounded-lg w-96 shadow-xl">
      <h2 class="text-xl font-bold mb-4">Configura√ß√µes</h2>

      <!-- Config EmailJS -->
      <h3 class="text-lg font-semibold">EmailJS</h3>
      <input id="emailPublicKey" type="text" placeholder="Public Key" class="w-full border p-2 mb-2 rounded">
      <input id="emailServiceId" type="text" placeholder="Service ID" class="w-full border p-2 mb-2 rounded">
      <input id="emailTemplateId" type="text" placeholder="Template ID" class="w-full border p-2 mb-2 rounded">

      <!-- Email de destino -->
      <input id="destEmail" type="email" placeholder="E-mail para notifica√ß√µes" class="w-full border p-2 mb-4 rounded">

      <!-- Config Operadores -->
      <h3 class="text-lg font-semibold">Operadores</h3>
      <div id="operatorList" class="mb-2"></div>
      <div class="flex gap-2">
        <input id="newOperator" type="text" placeholder="Nome do operador" class="flex-1 border p-2 rounded">
        <button onclick="addOperator()" class="bg-blue-500 text-white px-3 py-2 rounded">+ Adicionar</button>
      </div>

      <!-- A√ß√µes -->
      <div class="flex justify-end mt-4 gap-2">
        <button onclick="closeConfig()" class="px-4 py-2 bg-gray-300 rounded">Cancelar</button>
        <button onclick="saveConfig()" class="px-4 py-2 bg-green-600 text-white rounded">Salvar</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Supabase =====
    const SUPABASE_URL = "https://seu-projeto.supabase.co"; // üîß altere aqui
    const SUPABASE_KEY = "chave-anon"; // üîß altere aqui
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== Fun√ß√µes de Modal =====
    function openModal(){ document.getElementById("ticketModal").classList.remove("hidden"); }
    function closeModal(){ document.getElementById("ticketModal").classList.add("hidden"); }
    function openConfig(){ loadConfig(); document.getElementById("configModal").classList.remove("hidden"); }
    function closeConfig(){ document.getElementById("configModal").classList.add("hidden"); }

    // ===== Configura√ß√µes =====
    function saveConfig() {
      localStorage.setItem("emailPublicKey", document.getElementById("emailPublicKey").value);
      localStorage.setItem("emailServiceId", document.getElementById("emailServiceId").value);
      localStorage.setItem("emailTemplateId", document.getElementById("emailTemplateId").value);
      localStorage.setItem("destEmail", document.getElementById("destEmail").value);

      localStorage.setItem("operators", JSON.stringify(operators));
      closeConfig();
      renderOperators();
      renderOperatorSelect();
    }

    function loadConfig() {
      document.getElementById("emailPublicKey").value = localStorage.getItem("emailPublicKey") || "";
      document.getElementById("emailServiceId").value = localStorage.getItem("emailServiceId") || "";
      document.getElementById("emailTemplateId").value = localStorage.getItem("emailTemplateId") || "";
      document.getElementById("destEmail").value = localStorage.getItem("destEmail") || "";
      operators = JSON.parse(localStorage.getItem("operators")) || [];
      renderOperators();
      renderOperatorSelect();
    }

    let operators = [];

    function addOperator() {
      const op = document.getElementById("newOperator").value;
      if(op){ operators.push(op); document.getElementById("newOperator").value=""; renderOperators(); }
    }

    function renderOperators() {
      const list = document.getElementById("operatorList");
      list.innerHTML = operators.map(o => `<div class='p-1 border mb-1 rounded'>${o}</div>`).join("");
    }

    function renderOperatorSelect() {
      const select = document.getElementById("ticketOperator");
      select.innerHTML = operators.map(o => `<option>${o}</option>`).join("");
    }

    // ===== Tickets =====
    async function loadTickets(){
      const { data } = await supabaseClient.from("tickets").select("*").order("id", { ascending: false });
      const tbody = document.getElementById("ticketTable");
      tbody.innerHTML = data.map(t => `
        <tr>
          <td class="border p-2">${t.id}</td>
          <td class="border p-2">${t.title}</td>
          <td class="border p-2">${t.description}</td>
          <td class="border p-2">${t.operator}</td>
          <td class="border p-2">${t.status}</td>
          <td class="border p-2">
            ${t.status==="Aberto" ? `<button onclick="closeTicket(${t.id})" class="bg-red-600 text-white px-2 py-1 rounded">Encerrar</button>` : ""}
          </td>
        </tr>
      `).join("");
    }

    async function createTicket(){
      const title = document.getElementById("ticketTitle").value;
      const desc = document.getElementById("ticketDesc").value;
      const operator = document.getElementById("ticketOperator").value;

      await supabaseClient.from("tickets").insert([{ title, description: desc, operator, status: "Aberto" }]);
      await sendEmail("Novo Chamado Aberto", `T√≠tulo: ${title}\nDescri√ß√£o: ${desc}\nOperador: ${operator}`);

      closeModal();
      loadTickets();
    }

    async function closeTicket(id){
      await supabaseClient.from("tickets").update({ status: "Encerrado" }).eq("id", id);
      await sendEmail("Chamado Encerrado", `Chamado ID ${id} foi encerrado.`);
      loadTickets();
    }

    // ===== Envio de Email =====
    function sendEmail(subject, message) {
      emailjs.init(localStorage.getItem("emailPublicKey"));
      return emailjs.send(
        localStorage.getItem("emailServiceId"),
        localStorage.getItem("emailTemplateId"),
        {
          to_email: localStorage.getItem("destEmail"),
          subject: subject,
          message: message
        }
      );
    }

    // Inicializar
    loadConfig();
    loadTickets();
  </script>
</body>
</html>
