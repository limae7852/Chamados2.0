<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistema de Chamados</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 text-gray-900">

  <!-- ‚úÖ Aqui entra todo seu HTML (formul√°rio de ticket, tabela, modais etc.) -->
  <div class="p-6">
    <h1 class="text-2xl font-bold mb-4">Sistema de Chamados</h1>

    <!-- Bot√£o Configura√ß√µes -->
    <button id="btnSettings" class="px-4 py-2 bg-blue-600 text-white rounded">Configura√ß√µes</button>

    <!-- Formul√°rio de Chamados -->
    <form id="ticketForm" class="mt-4 space-y-2">
      <input id="subject" placeholder="Assunto" class="border p-2 w-full" required />
      <input id="client" placeholder="Cliente" class="border p-2 w-full" required />
      <select id="tech" class="border p-2 w-full"></select>
      <select id="priority" class="border p-2 w-full">
        <option value="low">Baixa</option>
        <option value="medium">M√©dia</option>
        <option value="high">Alta</option>
        <option value="critical">Cr√≠tica</option>
      </select>
      <textarea id="description" placeholder="Descri√ß√£o" class="border p-2 w-full"></textarea>
      <button type="submit" class="px-4 py-2 bg-green-600 text-white rounded">Abrir Chamado</button>
    </form>

    <!-- Tabela de Tickets -->
    <table class="mt-6 w-full border">
      <thead>
        <tr class="bg-gray-200">
          <th class="border px-4 py-2">ID</th>
          <th class="border px-4 py-2">Assunto</th>
          <th class="border px-4 py-2">Cliente</th>
          <th class="border px-4 py-2">T√©cnico</th>
          <th class="border px-4 py-2">Prioridade</th>
          <th class="border px-4 py-2">Status</th>
          <th class="border px-4 py-2">A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="ticketsList"></tbody>
    </table>
  </div>

  <!-- üîπ Script Firebase no FINAL -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, orderBy, query } 
      from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // üîπ Configura√ß√£o correta do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyBA16WHE768N9eUcqEoQqUF7uEIB82nNM0",
      authDomain: "chamados-37b34.firebaseapp.com",
      projectId: "chamados-37b34",
      storageBucket: "chamados-37b34.appspot.com",
      messagingSenderId: "164935126006",
      appId: "1:164935126006:web:e49fd19961993d5b62d5d7"
    };

    // üîπ Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    let tickets = [];
    let operators = [];
    let closeTicketId = null;

    // ====== OPERATORS ======
    async function fetchOperators(){
      const q = query(collection(db, "operators"), orderBy("name"));
      const snapshot = await getDocs(q);
      operators = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderOperators();
    }

    function renderOperators(){
      const techSelect = document.getElementById("tech");
      techSelect.innerHTML = '<option value="">Selecione o T√©cnico</option>';
      operators.forEach(op=>{
        const opt = document.createElement("option");
        opt.value = op.name; opt.textContent = op.name;
        techSelect.appendChild(opt);
      });
    }

    // ====== TICKETS ======
    async function fetchTickets(){
      const q = query(collection(db, "tickets"), orderBy("date"));
      const snapshot = await getDocs(q);
      tickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderTickets();
    }

    function renderTickets(){
      const ticketsList = document.getElementById("ticketsList");
      ticketsList.innerHTML = "";
      tickets.forEach(ticket=>{
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border px-4 py-2">${ticket.id}</td>
          <td class="border px-4 py-2">${ticket.subject}</td>
          <td class="border px-4 py-2">${ticket.client}</td>
          <td class="border px-4 py-2">${ticket.tech}</td>
          <td class="border px-4 py-2">${ticket.priority}</td>
          <td class="border px-4 py-2">${ticket.status}</td>
          <td class="border px-4 py-2">
            ${ticket.status!=="resolved"
              ? `<button onclick="closeTicket('${ticket.id}')" class="text-green-600 hover:underline">Encerrar</button>`
              : "‚úÖ Encerrado"}
          </td>`;
        ticketsList.appendChild(tr);
      });
    }

    async function addTicket(ticket){
      await addDoc(collection(db, "tickets"), ticket);
      fetchTickets();
    }

    async function closeTicket(id){
      await updateDoc(doc(db, "tickets", id), { status:'resolved' });
      fetchTickets();
    }
    window.closeTicket = closeTicket; // üîπ exp√µe no escopo global

    // ====== FORM ======
    const ticketForm = document.getElementById("ticketForm");
    ticketForm.addEventListener("submit", (e)=>{
      e.preventDefault();
      const ticket = {
        subject: document.getElementById("subject").value,
        client: document.getElementById("client").value,
        tech: document.getElementById("tech").value,
        priority: document.getElementById("priority").value,
        description: document.getElementById("description").value,
        status: "open",
        date: new Date().toISOString()
      };
      addTicket(ticket);
      e.target.reset();
    });

    // ====== INICIALIZA√á√ÉO ======
    fetchOperators();
    fetchTickets();
  </script>
</body>
</html>
