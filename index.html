<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistema de Chamados</title>
<script src="https://cdn.tailwindcss.com"></script>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, updateDoc, doc, orderBy, query } 
    from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

  // üîπ Configura√ß√£o do Firebase (substitua pelos dados do seu projeto!)
  const firebaseConfig = {
  apiKey: "AIzaSyBA16WHE768N9eUcqEoQqUF7uEIB82nNM0",
  authDomain: "chamados-37b34.firebaseapp.com",
  projectId: "chamados-37b34",
  storageBucket: "chamados-37b34.firebasestorage.app",
  messagingSenderId: "164935126006",
  appId: "1:164935126006:web:e49fd19961993d5b62d5d7"
};

  // üîπ Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ====== ESTADO ======
  let tickets = [];
  let operators = [];
  let closeTicketId = null;

  document.addEventListener("DOMContentLoaded", () => {
    // --- MODAL Configura√ß√µes ---
    const btnSettings = document.getElementById("btnSettings");
    const modalSettings = document.getElementById("modalSettings");
    const closeSettingsBtn = document.getElementById("closeSettingsBtn");
    const operatorsListEl = document.getElementById("operatorsList");
    const addOperatorBtn = document.getElementById("addOperatorBtn");
    const techSelect = document.getElementById("tech");

    const openSettings = () => { modalSettings.classList.remove("hidden"); modalSettings.classList.add("flex"); };
    const closeSettings = () => { modalSettings.classList.add("hidden"); modalSettings.classList.remove("flex"); };

    btnSettings?.addEventListener("click", openSettings);
    closeSettingsBtn?.addEventListener("click", closeSettings);
    modalSettings?.addEventListener("click", (e) => { if (e.target === modalSettings) closeSettings(); });

    // ====== OPERATORS ======
    async function fetchOperators(){
      const q = query(collection(db, "operators"), orderBy("name"));
      const snapshot = await getDocs(q);
      operators = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderOperators();
    }

    function renderOperators(){
      operatorsListEl.innerHTML = "";
      techSelect.innerHTML = '<option value="">Selecione o T√©cnico</option>';
      operators.forEach(op=>{
        const li = document.createElement("li");
        li.className = "flex justify-between items-center";
        li.innerHTML = `<span>${op.name}</span> <button data-id="${op.id}" class="text-red-600 hover:underline">Remover</button>`;
        operatorsListEl.appendChild(li);

        const opt = document.createElement("option");
        opt.value = op.name; opt.textContent = op.name;
        techSelect.appendChild(opt);
      });
    }

    async function addOperator(name){
      await addDoc(collection(db, "operators"), { name });
      fetchOperators();
    }

    async function removeOperator(id){
      await deleteDoc(doc(db, "operators", id));
      fetchOperators();
    }

    addOperatorBtn?.addEventListener("click", ()=>{
      const input = document.getElementById("newOperator");
      const name = input.value.trim();
      if (name) { addOperator(name); input.value = ""; }
    });

    operatorsListEl?.addEventListener("click",(e)=>{
      const btn = e.target.closest("button[data-id]");
      if (btn) removeOperator(btn.dataset.id);
    });

    // ====== TICKETS ======
    const ticketForm = document.getElementById("ticketForm");
    const ticketsList = document.getElementById("ticketsList");

    async function fetchTickets(){
      const q = query(collection(db, "tickets"), orderBy("date"));
      const snapshot = await getDocs(q);
      tickets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderTickets();
    }

    function renderTickets(){
      ticketsList.innerHTML = "";
      tickets.forEach(ticket=>{
        const tr = document.createElement("tr");
        tr.classList.add(`priority-${ticket.priority}`);
        tr.innerHTML = `
          <td class="border px-4 py-2">${ticket.id}</td>
          <td class="border px-4 py-2">${ticket.subject}</td>
          <td class="border px-4 py-2">${ticket.client}</td>
          <td class="border px-4 py-2">${ticket.tech}</td>
          <td class="border px-4 py-2 capitalize">${ticket.priority}</td>
          <td class="border px-4 py-2 capitalize">${ticket.status}</td>
          <td class="border px-4 py-2 space-x-2">
            <button onclick="viewDetails('${ticket.id}')" class="text-blue-600 hover:underline">Detalhes</button>
            ${ticket.status!=="resolved"
              ? `<button onclick="openCloseModal('${ticket.id}')" class="text-green-600 hover:underline">Encerrar</button>`
              : "‚úÖ Encerrado"}
          </td>`;
        ticketsList.appendChild(tr);
        if (ticket.priority === "critical") tr.classList.add("blink");
      });
    }

    async function addTicket(ticket){
      await addDoc(collection(db, "tickets"), ticket);
      fetchTickets();
    }

    async function closeTicket(id){
      await updateDoc(doc(db, "tickets", id), { status:'resolved' });
      fetchTickets();
    }

    ticketForm?.addEventListener("submit", (e)=>{
      e.preventDefault();
      const ticket = {
        subject: document.getElementById("subject").value,
        client: document.getElementById("client").value,
        tech: document.getElementById("tech").value,
        priority: document.getElementById("priority").value,
        description: document.getElementById("description").value,
        status: "open",
        date: new Date().toISOString()
      };
      addTicket(ticket);
      e.target.reset();
    });

    // ====== MODAIS DETALHES ======
    window.viewDetails = function(id){
      const t = tickets.find(tt=>tt.id===id);
      if (t){
        document.getElementById("detailsContent").innerHTML = `
          <p><strong>ID:</strong> ${t.id}</p>
          <p><strong>Assunto:</strong> ${t.subject}</p>
          <p><strong>Descri√ß√£o:</strong> ${t.description}</p>
          <p><strong>Cliente:</strong> ${t.client}</p>
          <p><strong>T√©cnico:</strong> ${t.tech}</p>
          <p><strong>Prioridade:</strong> ${t.priority}</p>
          <p><strong>Status:</strong> ${t.status}</p>
          <p><strong>Abertura:</strong> ${new Date(t.date).toLocaleString()}</p>
        `;
        const detailsModal = document.getElementById("detailsModal");
        detailsModal.classList.remove("hidden"); detailsModal.classList.add("flex");
      }
    };
    window.closeDetailsModal = function(){
      const m = document.getElementById("detailsModal");
      m.classList.add("hidden"); m.classList.remove("flex");
    };
    window.openCloseModal = function(id){
      closeTicketId = id;
      document.getElementById("closeMessage").textContent = `Deseja realmente encerrar o chamado #${id}?`;
      const m = document.getElementById("closeModal");
      m.classList.remove("hidden"); m.classList.add("flex");
    };
    window.closeCloseModal = function(){
      const m = document.getElementById("closeModal");
      m.classList.add("hidden"); m.classList.remove("flex");
    };
    window.confirmCloseTicket = function(){
      if (closeTicketId) { closeTicket(closeTicketId); closeCloseModal(); }
    };

    // ====== INICIALIZA√á√ÉO ======
    fetchOperators();
    fetchTickets();
  });
</script>
</head>
<body class="bg-gray-100 text-gray-900">
  <!-- ‚úÖ SEU HTML ORIGINAL INTEIRO (formul√°rio, tabela, modais) permanece IGUAL -->
</body>
</html>
